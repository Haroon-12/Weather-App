<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tables</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <div class="hamburger" id="hamburgerMenu">
        &#9776;
    </div>
    <div class="sidebar">
        <div class="logo">Weather</div>
        <nav>
            <a href="dashboard.html" id="dashboardLink">Dashboard</a>
            <a href="tables.html" id="tablesLink">Tables</a>
        </nav>
    </div>

    <div class="main-content" id="main-content">
        <div class="can">
            <div class="profile-circle">
                <img src="Images/profile2.png" alt="Profile" />
            </div>
            <h1>Tables</h1>
            <div class="search-section">
                <input type="text" id="city" placeholder="Enter city name">
                <button id="getWeatherBtn">Get Weather</button>
            </div>
            <div id="filter-section">
                <h2>Filters</h2>
                <label>
                    <input type="checkbox" id="ascTempCheckbox"> Show temperatures in ascending order <br>
                </label>
                <label>
                    <input type="checkbox" id="rainyDaysCheckbox"> Filter out days without rain <br>
                </label>
                <label>
                    <input type="checkbox" id="highestTempCheckbox"> Show the day with the highest temperature <br>
                </label>
                <label>
                    <input type="checkbox" id="descTempCheckbox"> Show temperatures in descending order <br>
                </label>
                <label>
                    <input type="checkbox" id="unitToggle"> Show in Fahrenheit
                </label>
            </div>
        </div>

        <div id="weather-widget" class="widget"></div>
        <div id="forecast-table" class="widget"></div>

        <div id="chatbot-section">
            <h2>Ask the Chatbot</h2>
            <input type="text" id="chatInput" placeholder="Ask something...">
            <button id="sendChatBtn">Send</button>
            <div id="chatbotResponse" class="widget"></div>
        </div>
    </div>

    <script>
        const unitToggle = document.getElementById('unitToggle');
        let units = 'metric';

        unitToggle.addEventListener('change', () => {
            units = unitToggle.checked ? 'imperial' : 'metric';
        });

        document.getElementById('getWeatherBtn').addEventListener('click', () => {
            const city = document.getElementById('city').value;
            const apiKey = '82e16c9b935bd9875cf32e0851c4e8d6'; // OpenWeather API key

            fetch(`https://api.openweathermap.org/geo/1.0/direct?q=${city}&limit=1&appid=${apiKey}`)
                .then(response => response.json())
                .then(data => {
                    if (data.length > 0) {
                        const lat = data[0].lat;
                        const lon = data[0].lon;

                        // Fetch current weather
                        fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&units=${units}&appid=${apiKey}`)
                            .then(response => response.json())
                            .then(weatherData => {
                                const tempUnit = units === 'metric' ? '째C' : '째F';
                                const weatherCondition = weatherData.weather[0].main.toLowerCase();

                                // Update the widget background based on weather conditions
                                const weatherWidget = document.getElementById('weather-widget');

                                console.log("Weather condition:", weatherCondition);

                                // Set background color 
                                if (weatherCondition.includes('clear')) {
                                    weatherWidget.style.backgroundImage = "url('Images/clear.jpg')";
                                } else if (weatherCondition.includes('clouds')) {
                                    weatherWidget.style.backgroundImage = "url('Images/clouds.jpg')";
                                } else if (weatherCondition.includes('rain')) {
                                    weatherWidget.style.backgroundImage = "url('Images/rain.jpeg.jpg')";
                                } else if (weatherCondition.includes('snow')) {
                                    weatherWidget.style.backgroundImage = "url('Images/snow.jpeg.jpg')";
                                } else if (weatherCondition.includes('thunder')) {
                                    weatherWidget.style.backgroundImage = "url('Images/thunder.jpeg.jpg')";
                                } else {
                                    weatherWidget.style.backgroundColor = '#FFFFFF';
                                }

                                weatherWidget.innerHTML = `
                                <h2>Current Weather in ${weatherData.name}</h2>
                                <p>Temperature: ${weatherData.main.temp} ${tempUnit}</p>
                                <p>Weather: ${weatherData.weather[0].description}</p>
                                <p>Humidity: ${weatherData.main.humidity}%</p>
                                <p>Wind Speed: ${weatherData.wind.speed} m/s</p>
                        `;

                                // Fetch 5-day forecast
                                fetch(`https://api.openweathermap.org/data/2.5/forecast?lat=${lat}&lon=${lon}&units=${units}&appid=${apiKey}`)
                                    .then(response => response.json())
                                    .then(forecastData => {
                                        let forecastList = forecastData.list.slice(0, 5);  // Taking data for 5 days
                                        let filteredForecast = forecastList;

                                        // Filter out days without rain if checked
                                        const rainyDaysCheckbox = document.getElementById('rainyDaysCheckbox');
                                        if (rainyDaysCheckbox.checked) {
                                            filteredForecast = filteredForecast.filter(item => item.weather[0].main.toLowerCase().includes('rain'));
                                        }

                                        // Show the day with the highest temperature if checked
                                        const highestTempCheckbox = document.getElementById('highestTempCheckbox');
                                        if (highestTempCheckbox.checked) {
                                            const highestTempDay = filteredForecast.reduce((max, item) => item.main.temp > max.main.temp ? item : max);
                                            filteredForecast = [highestTempDay];
                                        }

                                        // Sort temperatures
                                        const ascTempCheckbox = document.getElementById('ascTempCheckbox');
                                        const descTempCheckbox = document.getElementById('descTempCheckbox');
                                        if (ascTempCheckbox.checked) {
                                            filteredForecast.sort((a, b) => a.main.temp - b.main.temp);
                                        } else if (descTempCheckbox.checked) {
                                            filteredForecast.sort((a, b) => b.main.temp - a.main.temp);
                                        }

                                        // Generate forecast table
                                        let forecastHTML = `<h3>5-Day Forecast</h3><table>
                            <tr><th>Date</th><th>Temperature</th><th>Weather</th></tr>`;
                                        filteredForecast.forEach(item => {
                                            forecastHTML += `
                                <tr>
                                    <td>${new Date(item.dt_txt).toLocaleDateString()}</td>
                                    <td>${item.main.temp} ${units === 'metric' ? '째C' : '째F'}</td>
                                    <td>${item.weather[0].description}</td>
                                </tr>
                            `;
                                        });
                                        forecastHTML += '</table>';
                                        document.getElementById('forecast-table').innerHTML = forecastHTML;
                                    });
                            });
                    } else {
                        alert("City not found. Please try again.");
                    }
                })
                .catch(error => {
                    console.error("Error fetching coordinates:", error);
                });
        });

        
        // Chatbot Integration
        document.getElementById('sendChatBtn').addEventListener('click', () => {
            const chatInput = document.getElementById('chatInput').value;
            document.getElementById('chatbotResponse').innerHTML = 'Checking...'; // Show loading text
            getChatbotResponse(chatInput);
        });

        // Function to get chatbot response
        async function getChatbotResponse(input) {
            const apiKey = 'AIzaSyBkN7ha-nCycuRgF_mR19fr21G38DnvXyE'; // Gemini API key
            const url = 'https://generativelanguage.googleapis.com/v1/models/gemini-pro:generateContent?key=' + apiKey;

            const body = {
                contents: [{ 
                    role: "user", 
                    parts: [{ text: input }] 
                }]
            };

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(body),
                });

                // Check for response status
                if (!response.ok) {
                    const errorResponse = await response.json();
                    console.error('Error response:', errorResponse);
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                const chatbotResponse = data?.candidates[0].content.parts[0].text || "No response found.";
                document.getElementById('chatbotResponse').innerHTML = chatbotResponse;
            } catch (error) {
                console.error('Error fetching chatbot response:', error);
                document.getElementById('chatbotResponse').innerHTML = "Error getting response. Please try again.";
            }
        }

        // JavaScript to toggle sidebar visibility
        document.getElementById('hamburgerMenu').addEventListener('click', () => {
            const sidebar = document.querySelector('.sidebar');
            sidebar.classList.toggle('active');
        });

    </script>
</body>

</html>